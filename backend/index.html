<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TasteFind ‚Äî AI Restaurant Recommender</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:ital,wght@0,300;0,400;0,500;1,300&display=swap" rel="stylesheet" />
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    :root {
      --bg:       #0d0f1a;
      --surface:  rgba(255,255,255,0.04);
      --border:   rgba(255,255,255,0.09);
      --orange:   #f97316;
      --orange2:  #ea580c;
      --orange-dim: rgba(249,115,22,0.12);
      --text:     #f1f5f9;
      --muted:    #64748b;
      --muted2:   #94a3b8;
      --green:    #4ade80;
      --gold:     #fbbf24;
      --purple:   #a78bfa;
      --font-head: 'Syne', sans-serif;
      --font-body: 'DM Sans', sans-serif;
      --r-sm: 8px; --r-md: 14px; --r-lg: 20px; --r-xl: 28px;
    }
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html { font-size: 16px; scroll-behavior: smooth; }
    body { font-family: var(--font-body); background: var(--bg); color: var(--text); -webkit-font-smoothing: antialiased; }

    /* ‚îÄ‚îÄ Blobs ‚îÄ‚îÄ */
    .blob { position: fixed; border-radius: 50%; pointer-events: none; z-index: 0; }
    .blob-1 { top:-15%; right:-8%; width:580px; height:580px; background:radial-gradient(circle, rgba(249,115,22,0.13) 0%, transparent 70%); }
    .blob-2 { bottom:-10%; left:-12%; width:480px; height:480px; background:radial-gradient(circle, rgba(168,85,247,0.08) 0%, transparent 70%); }
    .blob-3 { top:50%; left:50%; transform:translate(-50%,-50%); width:900px; height:400px; background:radial-gradient(ellipse, rgba(249,115,22,0.04) 0%, transparent 70%); }

    /* ‚îÄ‚îÄ Layout ‚îÄ‚îÄ */
    .app { position: relative; min-height: 100vh; display: flex; flex-direction: column; }
    .wrap { flex: 1; max-width: 820px; margin: 0 auto; padding: 0 20px 80px; width: 100%; position: relative; z-index: 1; }

    /* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
    .header { position: sticky; top: 0; z-index: 100; background: rgba(13,15,26,0.85); backdrop-filter: blur(16px); border-bottom: 1px solid var(--border); }
    .header-inner { max-width: 820px; margin: 0 auto; padding: 14px 20px; display: flex; align-items: center; justify-content: space-between; gap: 12px; flex-wrap: wrap; }
    .logo-row { display: flex; align-items: center; gap: 10px; }
    .logo-emoji { font-size: 22px; }
    .logo-name { font-family: var(--font-head); font-size: 1.35rem; font-weight: 800; color: var(--orange); letter-spacing: -0.03em; line-height: 1; }
    .logo-sub { font-size: 0.7rem; color: var(--muted); margin-top: 2px; }

    /* Model badge */
    .model-badge { display: flex; align-items: center; gap: 7px; background: rgba(249,115,22,0.08); border: 1px solid rgba(249,115,22,0.22); border-radius: 999px; padding: 6px 14px; font-size: 0.75rem; }
    .badge-dot { width: 7px; height: 7px; border-radius: 50%; background: var(--green); box-shadow: 0 0 7px var(--green); flex-shrink: 0; animation: pulseGreen 2.5s ease-in-out infinite; }
    @keyframes pulseGreen { 0%,100%{opacity:1;transform:scale(1)} 50%{opacity:0.6;transform:scale(0.8)} }
    .badge-info { display: flex; flex-direction: column; line-height: 1.25; }
    .badge-label { color: var(--muted); font-size: 0.62rem; }
    .badge-model { color: var(--orange); font-family: var(--font-head); font-weight: 700; font-size: 0.8rem; }
    .badge-sep { color: rgba(255,255,255,0.15); }
    .badge-groq { color: var(--purple); font-weight: 600; }

    /* ‚îÄ‚îÄ Status pill ‚îÄ‚îÄ */
    .status-pill { display: flex; align-items: center; gap: 7px; font-size: 0.72rem; color: var(--muted); border: 1px solid var(--border); border-radius: 999px; padding: 5px 12px; }
    .status-dot { width: 7px; height: 7px; border-radius: 50%; flex-shrink: 0; transition: background 0.4s; }

    /* ‚îÄ‚îÄ Hero ‚îÄ‚îÄ */
    .hero { padding: 56px 0 36px; }
    .hero-title { font-family: var(--font-head); font-size: clamp(42px, 7vw, 76px); font-weight: 800; line-height: 1.06; letter-spacing: -0.03em; margin-bottom: 16px; }
    .hero-title em { font-style: italic; color: var(--orange); font-weight: 400; }
    .hero-sub { font-size: 0.92rem; color: var(--muted); line-height: 1.75; max-width: 500px; }

    /* ‚îÄ‚îÄ Search card ‚îÄ‚îÄ */
    .search-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--r-xl); padding: 28px; margin-bottom: 40px; backdrop-filter: blur(8px); }
    .search-card-title { font-family: var(--font-head); font-size: 1.35rem; font-weight: 700; color: var(--text); margin-bottom: 4px; }
    .search-card-hint { font-size: 0.85rem; color: var(--muted); margin-bottom: 20px; }

    /* ‚îÄ‚îÄ Suggestions ‚îÄ‚îÄ */
    .suggestions-label { font-size: 0.7rem; font-weight: 600; letter-spacing: 0.1em; text-transform: uppercase; color: var(--muted); margin-bottom: 8px; }
    .chips { display: flex; flex-wrap: wrap; gap: 7px; margin-bottom: 24px; }
    .chip { display: flex; align-items: center; gap: 5px; background: var(--orange-dim); border: 1px solid rgba(249,115,22,0.22); border-radius: 999px; padding: 6px 13px; color: #fb923c; font-size: 0.78rem; cursor: pointer; font-family: var(--font-body); transition: all 0.15s; }
    .chip:hover { background: rgba(249,115,22,0.2); border-color: rgba(249,115,22,0.45); transform: translateY(-1px); }

    /* ‚îÄ‚îÄ Form fields ‚îÄ‚îÄ */
    .fields { display: flex; flex-direction: column; gap: 16px; margin-bottom: 20px; }
    .field-row { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
    .field-group { display: flex; flex-direction: column; gap: 5px; }
    .field-label { font-size: 0.75rem; font-weight: 600; color: var(--muted2); letter-spacing: 0.03em; }
    .field-required { color: var(--orange); }
    .field-optional { color: var(--muted); font-weight: 400; }
    input {
      font-family: var(--font-body); font-size: 0.9rem;
      background: rgba(255,255,255,0.05); border: 1px solid var(--border);
      border-radius: var(--r-sm); padding: 10px 14px; color: var(--text);
      outline: none; transition: border-color 0.2s, box-shadow 0.2s; width: 100%;
    }
    input:focus { border-color: var(--orange); box-shadow: 0 0 0 3px rgba(249,115,22,0.15); }
    input::placeholder { color: #475569; }

    /* ‚îÄ‚îÄ Toggle button groups ‚îÄ‚îÄ */
    .toggle-row { display: flex; flex-wrap: wrap; gap: 7px; }
    .toggle-btn { font-family: var(--font-body); font-size: 0.8rem; background: rgba(255,255,255,0.04); border: 1px solid var(--border); border-radius: var(--r-sm); padding: 7px 13px; color: var(--muted2); cursor: pointer; transition: all 0.15s; }
    .toggle-btn:hover { border-color: rgba(249,115,22,0.3); color: var(--text); }
    .toggle-btn.active { background: rgba(249,115,22,0.15); border-color: rgba(249,115,22,0.5); color: var(--orange); }

    /* ‚îÄ‚îÄ Error ‚îÄ‚îÄ */
    .error-box { background: rgba(239,68,68,0.1); border: 1px solid rgba(239,68,68,0.3); border-radius: var(--r-md); padding: 12px 16px; color: #fca5a5; font-size: 0.87rem; margin-bottom: 14px; }

    /* ‚îÄ‚îÄ Submit ‚îÄ‚îÄ */
    .submit-btn { width: 100%; background: linear-gradient(135deg, var(--orange), var(--orange2)); border: none; border-radius: var(--r-md); padding: 14px; color: #fff; font-family: var(--font-head); font-weight: 700; font-size: 1rem; cursor: pointer; box-shadow: 0 4px 24px rgba(249,115,22,0.3); transition: all 0.2s; letter-spacing: 0.01em; }
    .submit-btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 8px 32px rgba(249,115,22,0.4); }
    .submit-btn:disabled { background: linear-gradient(135deg, #92400e, #78350f); box-shadow: none; cursor: not-allowed; }
    .loading-hint { text-align: center; color: var(--muted); font-size: 0.76rem; margin-top: 10px; }

    /* ‚îÄ‚îÄ Loader ‚îÄ‚îÄ */
    .loader { display: flex; flex-direction: column; align-items: center; gap: 16px; padding: 60px 0; }
    .loader-ring { width: 44px; height: 44px; border: 2px solid var(--border); border-top-color: var(--orange); border-radius: 50%; animation: spin 0.9s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .loader-text { font-size: 0.75rem; letter-spacing: 0.12em; color: var(--muted); text-transform: uppercase; }

    /* ‚îÄ‚îÄ Top pick banner ‚îÄ‚îÄ */
    .top-pick-banner { background: linear-gradient(135deg, rgba(249,115,22,0.15), rgba(234,88,12,0.07)); border: 1px solid rgba(249,115,22,0.3); border-radius: var(--r-lg); padding: 18px 22px; margin-bottom: 16px; display: flex; align-items: center; gap: 14px; }
    .top-pick-tag { font-family: var(--font-head); font-size: 0.68rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; color: var(--orange); white-space: nowrap; }
    .top-pick-name { font-family: var(--font-head); font-size: 1.35rem; font-weight: 700; color: var(--text); }

    /* ‚îÄ‚îÄ AI Panel ‚îÄ‚îÄ */
    .ai-panel { background: var(--surface); border: 1px solid var(--border); border-radius: var(--r-xl); padding: 28px; margin-bottom: 28px; }
    .ai-panel-header { display: flex; align-items: center; gap: 14px; padding-bottom: 18px; border-bottom: 1px solid var(--border); margin-bottom: 18px; }
    .ai-llama-icon { font-size: 2rem; }
    .ai-panel-title { font-family: var(--font-head); font-weight: 700; font-size: 1rem; color: var(--text); }
    .ai-panel-sub { font-size: 0.75rem; color: var(--muted); margin-top: 2px; }
    .ai-expand-btn { margin-left: auto; background: none; border: 1px solid var(--border); border-radius: 6px; padding: 5px 12px; color: var(--muted2); font-size: 0.75rem; font-family: var(--font-body); cursor: pointer; transition: all 0.15s; }
    .ai-expand-btn:hover { border-color: var(--orange); color: var(--orange); }
    .ai-content { font-size: 0.88rem; line-height: 1.8; color: #cbd5e1; }
    .ai-content h1,.ai-content h2,.ai-content h3 { font-family: var(--font-head); color: var(--orange); margin: 14px 0 6px; font-size: 1rem; }
    .ai-content strong { color: var(--text); font-weight: 600; }
    .ai-content p { margin-bottom: 10px; }
    .ai-content ul { padding-left: 18px; margin-bottom: 10px; }
    .ai-content li { margin-bottom: 4px; }

    /* ‚îÄ‚îÄ Cards ‚îÄ‚îÄ */
    .cards-header { display: flex; align-items: baseline; gap: 12px; margin-bottom: 18px; }
    .section-title { font-family: var(--font-head); font-size: 1.6rem; font-weight: 700; color: var(--text); }
    .count-chip { font-size: 0.72rem; color: var(--muted); border: 1px solid var(--border); border-radius: 999px; padding: 3px 10px; }
    .cards-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); gap: 16px; }

    /* Restaurant card */
    .r-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--r-lg); overflow: hidden; transition: transform 0.22s, box-shadow 0.22s; animation: fadeUp 0.4s ease both; }
    .r-card:hover { transform: translateY(-4px); box-shadow: 0 12px 40px rgba(0,0,0,0.35); }
    .r-card.is-top { border-color: rgba(249,115,22,0.4); box-shadow: 0 0 0 1px rgba(249,115,22,0.2); }
    @keyframes fadeUp { from{opacity:0;transform:translateY(18px)} to{opacity:1;transform:translateY(0)} }
    .r-top-ribbon { background: var(--orange); color: #fff; font-family: var(--font-head); font-size: 0.68rem; font-weight: 700; letter-spacing: 0.12em; text-transform: uppercase; padding: 5px 14px; text-align: center; }
    .r-img { width: 100%; height: 175px; object-fit: cover; display: block; background: rgba(255,255,255,0.03); }
    .r-img-placeholder { width: 100%; height: 175px; background: linear-gradient(135deg, rgba(249,115,22,0.06), rgba(168,85,247,0.06)); display: flex; align-items: center; justify-content: center; font-size: 48px; }
    .r-body { padding: 16px 18px; }
    .r-top-row { display: flex; align-items: flex-start; justify-content: space-between; gap: 8px; margin-bottom: 8px; }
    .r-name { font-family: var(--font-head); font-size: 1.05rem; font-weight: 700; color: var(--text); line-height: 1.2; }
    .r-price { font-size: 0.78rem; color: #4ade80; margin-top: 2px; font-weight: 600; }
    .r-meta { display: flex; align-items: center; gap: 6px; flex-shrink: 0; }
    .r-stars { color: var(--gold); font-size: 0.78rem; }
    .r-rating { font-size: 0.75rem; color: var(--muted); white-space: nowrap; }
    .r-tags { display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 10px; }
    .r-tag { font-size: 0.68rem; letter-spacing: 0.07em; text-transform: uppercase; background: rgba(90,112,85,0.12); color: #6ebd6a; border-radius: 4px; padding: 3px 7px; }
    .r-address { font-size: 0.78rem; color: var(--muted); margin-bottom: 12px; display: flex; gap: 5px; line-height: 1.5; }
    .r-footer { display: flex; align-items: center; justify-content: space-between; padding-top: 12px; border-top: 1px solid var(--border); }
    .r-phone { font-size: 0.75rem; color: var(--muted); }
    .r-actions { display: flex; align-items: center; gap: 10px; }
    .reviews-btn { font-family: var(--font-body); font-size: 0.72rem; font-weight: 500; letter-spacing: 0.07em; color: var(--muted2); background: none; border: 1px solid var(--border); border-radius: 6px; padding: 5px 11px; cursor: pointer; transition: all 0.15s; }
    .reviews-btn:hover { border-color: var(--orange); color: var(--orange); }
    .maps-link { font-size: 0.72rem; font-weight: 700; letter-spacing: 0.1em; text-transform: uppercase; color: var(--orange); text-decoration: none; transition: opacity 0.15s; }
    .maps-link:hover { opacity: 0.7; }

    /* ‚îÄ‚îÄ Reviews Modal ‚îÄ‚îÄ */
    .modal-backdrop { position: fixed; inset: 0; z-index: 200; background: rgba(10,12,22,0.75); backdrop-filter: blur(8px); display: flex; align-items: center; justify-content: center; padding: 20px; animation: fadeIn 0.18s ease; }
    @keyframes fadeIn { from{opacity:0} to{opacity:1} }
    .modal { background: #141726; border: 1px solid var(--border); border-radius: var(--r-xl); width: 100%; max-width: 560px; max-height: 85vh; overflow-y: auto; animation: slideUp 0.22s ease; }
    @keyframes slideUp { from{opacity:0;transform:translateY(16px)} to{opacity:1;transform:translateY(0)} }
    .modal-header { display: flex; align-items: flex-start; justify-content: space-between; padding: 22px 22px 16px; border-bottom: 1px solid var(--border); gap: 12px; }
    .modal-title { font-family: var(--font-head); font-size: 1.25rem; font-weight: 700; color: var(--text); }
    .modal-sub { font-size: 0.7rem; color: var(--muted); margin-top: 3px; letter-spacing: 0.07em; text-transform: uppercase; }
    .modal-close { font-size: 14px; background: none; border: 1px solid var(--border); border-radius: 6px; width: 30px; height: 30px; cursor: pointer; color: var(--muted); flex-shrink: 0; transition: all 0.15s; }
    .modal-close:hover { background: var(--orange); color: #fff; border-color: var(--orange); }
    .modal-loading { display: flex; flex-direction: column; align-items: center; gap: 14px; padding: 44px; font-size: 0.78rem; color: var(--muted); text-transform: uppercase; letter-spacing: 0.1em; }
    .ai-summary-block { background: rgba(249,115,22,0.07); border: 1px solid rgba(249,115,22,0.18); border-radius: var(--r-md); margin: 16px; padding: 16px 18px; }
    .ai-summary-label { display: flex; align-items: center; gap: 7px; font-size: 0.68rem; font-weight: 700; letter-spacing: 0.15em; text-transform: uppercase; color: var(--orange); margin-bottom: 8px; }
    .ai-summary-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--orange); animation: pulseGreen 2s ease-in-out infinite; }
    .ai-summary-text { font-size: 0.85rem; line-height: 1.75; color: var(--muted2); }
    .reviews-list { padding: 14px; display: flex; flex-direction: column; gap: 10px; }
    .review-item { background: var(--surface); border: 1px solid var(--border); border-radius: var(--r-md); padding: 14px 16px; }
    .review-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 7px; }
    .review-author { font-size: 0.85rem; font-weight: 600; color: var(--text); }
    .review-stars { font-size: 0.78rem; color: var(--gold); }
    .review-text { font-size: 0.82rem; line-height: 1.7; color: var(--muted2); margin-bottom: 6px; }
    .review-date { font-size: 0.68rem; color: var(--muted); }

    /* ‚îÄ‚îÄ Footer ‚îÄ‚îÄ */
    .footer { border-top: 1px solid var(--border); padding: 18px 24px; text-align: center; font-size: 0.72rem; color: var(--muted); display: flex; align-items: center; justify-content: center; gap: 8px; flex-wrap: wrap; position: relative; z-index: 1; }
    .footer-badge { background: var(--surface); border: 1px solid var(--border); border-radius: 999px; padding: 3px 10px; color: var(--muted); }

    /* ‚îÄ‚îÄ Geo button ‚îÄ‚îÄ */
    .geo-btn { display:flex; align-items:center; gap:6px; background:rgba(249,115,22,0.08); border:1px solid rgba(249,115,22,0.25); border-radius:8px; padding:9px 13px; color:#fb923c; font-size:0.82rem; font-family:var(--font-body); cursor:pointer; transition:all 0.15s; white-space:nowrap; flex-shrink:0; }
    .geo-btn:hover { background:rgba(249,115,22,0.18); border-color:rgba(249,115,22,0.5); }
    .geo-btn:disabled { opacity:0.5; cursor:not-allowed; }
    .location-row { display:flex; gap:8px; align-items:stretch; }
    .location-row input { flex:1; }

    /* ‚îÄ‚îÄ Responsive ‚îÄ‚îÄ */
    @media (max-width: 640px) {
      .field-row { grid-template-columns: 1fr; }
      .cards-grid { grid-template-columns: 1fr; }
      .hero-title { font-size: 38px; }
      .header-inner { flex-direction: column; align-items: flex-start; }
      .model-badge { align-self: flex-start; }
    }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 5px; }
    ::-webkit-scrollbar-track { background: #1e2030; }
    ::-webkit-scrollbar-thumb { background: var(--orange); border-radius: 3px; }
  </style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const { useState, useEffect } = React;
const API_BASE = "https://dploy-vercel-tablefind-production.up.railway.app";

const SUGGESTIONS = [
  { icon: "üìç", label: "Find restaurants near me",       location: "New York, NY",      cuisine: "" },
  { icon: "üçï", label: "Best pizza spots in Chicago",    location: "Chicago, IL",       cuisine: "pizza" },
  { icon: "üç£", label: "Sushi date night in SF",         location: "San Francisco, CA", cuisine: "sushi" },
  { icon: "üåÆ", label: "Tacos in Los Angeles",           location: "Los Angeles, CA",   cuisine: "tacos" },
  { icon: "üçî", label: "Burgers in Austin",              location: "Austin, TX",        cuisine: "burgers" },
  { icon: "ü•ó", label: "Vegan-friendly spots in Seattle",location: "Seattle, WA",       cuisine: "vegan" },
  { icon: "üçú", label: "Ramen in New York",              location: "New York, NY",      cuisine: "ramen" },
  { icon: "üç∑", label: "Fine dining in Miami",           location: "Miami, FL",         cuisine: "" },
];

const BUDGETS   = [{ v:"low", l:"üí∞ Budget $" }, { v:"medium", l:"üí≥ Mid $$" }, { v:"high", l:"‚ú® Splurge $$$" }];
const OCCASIONS = [{ v:"casual", l:"üòä Casual" }, { v:"date", l:"üíë Date Night" }, { v:"business", l:"üíº Business" }, { v:"family", l:"üë®‚Äçüë©‚Äçüëß Family" }];
const LOADER_MSGS = ["Scanning Google Maps listings‚Ä¶","Asking Llama 3 70B on Groq‚Ä¶","Curating your top picks‚Ä¶","Almost there‚Ä¶"];

async function apiFetch(path, opts = {}) {
  let res;
  try {
    res = await fetch(API_BASE + path, {
      headers: { "Content-Type": "application/json" },
      mode: "cors",
      ...opts
    });
  } catch (networkErr) {
    throw new Error(
      "Cannot reach backend at " + API_BASE + ". " +
      "Make sure you ran: cd backend && python main.py"
    );
  }
  let data;
  try {
    data = await res.json();
  } catch {
    throw new Error("Server returned invalid response (status " + res.status + ")");
  }
  if (!res.ok) throw new Error(data.detail || "HTTP " + res.status);
  return data;
}

function renderMarkdown(text) {
  return text
    .replace(/^### (.+)$/gm, "<h3>$1</h3>")
    .replace(/^## (.+)$/gm,  "<h2>$1</h2>")
    .replace(/^# (.+)$/gm,   "<h1>$1</h1>")
    .replace(/\*\*(.+?)\*\*/g, "<strong>$1</strong>")
    .replace(/\*(.+?)\*/g, "<em>$1</em>")
    .replace(/^[-*] (.+)$/gm, "<li>$1</li>")
    .replace(/(<li>.*<\/li>\n?)+/g, m => "<ul>" + m + "</ul>")
    .replace(/\n\n/g, "</p><p>")
    .replace(/TOP_PICK:.*/g, "");
}

function starsStr(r) {
  const f = Math.floor(r), h = r % 1 >= 0.5 ? 1 : 0;
  return "‚òÖ".repeat(f) + (h ? "¬Ω" : "") + "‚òÜ".repeat(5 - f - h);
}

/* ‚îÄ‚îÄ Loader ‚îÄ‚îÄ */
function Loader() {
  const [i, setI] = useState(0);
  useEffect(() => {
    const t = setInterval(() => setI(x => (x + 1) % LOADER_MSGS.length), 1800);
    return () => clearInterval(t);
  }, []);
  return (
    <div className="loader">
      <div className="loader-ring" />
      <div className="loader-text">{LOADER_MSGS[i]}</div>
    </div>
  );
}

/* ‚îÄ‚îÄ Reviews Modal ‚îÄ‚îÄ */
function ReviewsModal({ restaurant, onClose }) {
  const [data, setData]       = useState(null);
  const [loading, setLoading] = useState(true);
  const [error, setError]     = useState(null);

  useEffect(() => {
    apiFetch("/api/reviews/" + restaurant.id)
      .then(setData).catch(e => setError(e.message))
      .finally(() => setLoading(false));
    const h = e => e.key === "Escape" && onClose();
    window.addEventListener("keydown", h);
    return () => window.removeEventListener("keydown", h);
  }, []);

  return (
    <div className="modal-backdrop" onClick={e => e.target === e.currentTarget && onClose()}>
      <div className="modal">
        <div className="modal-header">
          <div>
            <div className="modal-title">{restaurant.name}</div>
            <div className="modal-sub">Reviews ¬∑ AI Summary</div>
          </div>
          <button className="modal-close" onClick={onClose}>‚úï</button>
        </div>

        {loading && (
          <div className="modal-loading">
            <div className="loader-ring" />
            <span>Loading reviews‚Ä¶</span>
          </div>
        )}
        {error && <div className="error-box" style={{margin:"16px"}}>‚ö†Ô∏è {error}</div>}
        {data && (
          <>
            <div className="ai-summary-block">
              <div className="ai-summary-label">
                <span className="ai-summary-dot" />
                ü¶ô Llama 3 70B Summary
              </div>
              <p className="ai-summary-text">{data.ai_summary}</p>
            </div>
            <div className="reviews-list">
              {data.reviews.length === 0 && <p style={{color:"var(--muted)",fontSize:"0.85rem"}}>No reviews found.</p>}
              {data.reviews.map((r, i) => (
                <div key={i} className="review-item">
                  <div className="review-top">
                    <span className="review-author">{r.user?.name || "Anonymous"}</span>
                    <span className="review-stars">{"‚òÖ".repeat(Math.round(r.rating))}{"‚òÜ".repeat(5 - Math.round(r.rating))}</span>
                  </div>
                  <p className="review-text">{r.text}</p>
                  {r.time_created && (
                    <span className="review-date">
                      {new Date(r.time_created).toLocaleDateString("en-US", { year:"numeric", month:"short", day:"numeric" })}
                    </span>
                  )}
                </div>
              ))}
            </div>
          </>
        )}
      </div>
    </div>
  );
}

/* ‚îÄ‚îÄ Restaurant Card ‚îÄ‚îÄ */
function RestaurantCard({ restaurant: r, isTop, index, onReviews }) {
  const dist = r.distance_meters
    ? r.distance_meters < 1000
      ? Math.round(r.distance_meters) + "m away"
      : (r.distance_meters / 1000).toFixed(1) + "km away"
    : null;

  return (
    <div className={"r-card" + (isTop ? " is-top" : "")} style={{ animationDelay: index * 80 + "ms" }}>
      {isTop && <div className="r-top-ribbon">üèÜ Top Pick</div>}

      {r.image_url
        ? <img src={r.image_url} alt={r.name} className="r-img" loading="lazy" />
        : <div className="r-img-placeholder">üçΩÔ∏è</div>
      }

      <div className="r-body">
        <div className="r-top-row">
          <div>
            <div className="r-name">{r.name}</div>
            {r.price && <div className="r-price">{r.price}</div>}
          </div>
          <div className="r-meta">
            <span className="r-stars">{starsStr(r.rating)}</span>
            <span className="r-rating">{r.rating} ({r.review_count})</span>
          </div>
        </div>

        <div className="r-tags">
          {r.categories.slice(0, 3).map(c => <span key={c} className="r-tag">{c}</span>)}
          {dist && <span className="r-tag">{dist}</span>}
        </div>

        <div className="r-address"><span>‚óé</span><span>{r.address}</span></div>

        <div className="r-footer">
          <span className="r-phone">{r.phone || "‚Äî"}</span>
          <div className="r-actions">
            <button className="reviews-btn" onClick={onReviews}>Reviews ‚ú¶</button>
            {r.maps_url && <a href={r.maps_url} target="_blank" rel="noreferrer" className="maps-link">Maps ‚Üó</a>}
          </div>
        </div>
      </div>
    </div>
  );
}

/* ‚îÄ‚îÄ AI Panel ‚îÄ‚îÄ */
function AIPanel({ text, topPick, count }) {
  const [expanded, setExpanded] = useState(true);
  return (
    <div className="ai-panel">
      <div className="ai-panel-header">
        <span className="ai-llama-icon">ü¶ô</span>
        <div>
          <div className="ai-panel-title">Llama 3 70B Recommends</div>
          <div className="ai-panel-sub">via Groq ¬∑ {count} restaurants evaluated</div>
        </div>
        {topPick && (
          <span style={{ marginLeft:"auto", marginRight:"10px", background:"rgba(249,115,22,0.15)", border:"1px solid rgba(249,115,22,0.35)", borderRadius:"999px", padding:"4px 12px", fontSize:"0.75rem", color:"var(--orange)", fontFamily:"var(--font-head)", fontWeight:700, whiteSpace:"nowrap" }}>
            üèÜ {topPick}
          </span>
        )}
        <button className="ai-expand-btn" onClick={() => setExpanded(e => !e)}>
          {expanded ? "Collapse ‚Üë" : "Expand ‚Üì"}
        </button>
      </div>
      {expanded && (
        <div className="ai-content" dangerouslySetInnerHTML={{ __html: "<p>" + renderMarkdown(text) + "</p>" }} />
      )}
    </div>
  );
}

/* ‚îÄ‚îÄ Search Form ‚îÄ‚îÄ */
function SearchForm({ onSearch, loading }) {
  const [location, setLocation] = useState("");
  const [cuisine,  setCuisine]  = useState("");
  const [budget,   setBudget]   = useState("medium");
  const [occasion, setOccasion] = useState("casual");
  const [dietary,  setDietary]  = useState("");
  const [limit,    setLimit]    = useState(5);
  const [error,    setError]    = useState("");
  const [dots,     setDots]     = useState("");
  const [geoLoading, setGeoLoading] = useState(false);
  const [coords,     setCoords]     = useState(null); // {lat, lng}

  const handleGeolocate = () => {
    if (!navigator.geolocation) {
      setError("Geolocation not supported. Please type your city name.");
      return;
    }
    // Browsers block geolocation on http:// ‚Äî must be https:// or localhost
    if (location.protocol === "http:" && location.hostname !== "localhost" && location.hostname !== "127.0.0.1") {
      setError("Geolocation requires HTTPS. Please type your city name (e.g. 'Seattle, WA').");
      return;
    }
    setGeoLoading(true);
    navigator.geolocation.getCurrentPosition(
      pos => {
        const { latitude: lat, longitude: lng } = pos.coords;
        setCoords({ lat, lng });
        setLocation(`${lat.toFixed(4)}, ${lng.toFixed(4)}`);
        setGeoLoading(false);
        setError("");
      },
      err => {
        setGeoLoading(false);
        const msgs = {
          1: "Location access denied. Please allow location in your browser settings, or type your city name (e.g. 'Seattle, WA').",
          2: "Location unavailable. Please type your city name (e.g. 'Seattle, WA').",
          3: "Location request timed out. Please type your city name (e.g. 'Seattle, WA').",
        };
        setError(msgs[err.code] || "Could not get location. Please type your city name.");
      },
      { timeout: 10000, enableHighAccuracy: false }
    );
  };

  useEffect(() => {
    if (!loading) { setDots(""); return; }
    const t = setInterval(() => setDots(d => d.length >= 3 ? "" : d + "."), 420);
    return () => clearInterval(t);
  }, [loading]);

  const applySuggestion = s => { setLocation(s.location); setCuisine(s.cuisine); setError(""); };

  const handleSubmit = () => {
    if (!location.trim()) { setError("Please enter a location first üìç"); return; }
    setError("");
    onSearch({ location, cuisine: cuisine || undefined, budget, occasion, dietary_restrictions: dietary || undefined, radius_meters: 5000, limit, ...(coords || {}) });
  };

  return (
    <div className="search-card">
      <div className="search-card-title">Where are you hungry? üòã</div>
      <div className="search-card-hint">Tell me what you're craving and I'll find the perfect spot!</div>

      <div className="suggestions-label">‚ú® Try one of these</div>
      <div className="chips">
        {SUGGESTIONS.map((s, i) => (
          <button key={i} className="chip" onClick={() => applySuggestion(s)}>
            <span>{s.icon}</span>{s.label}
          </button>
        ))}
      </div>

      <div className="fields">
        <div className="field-group">
          <label className="field-label">üìç Location <span className="field-required">*</span></label>
          <div className="location-row">
            <input
              placeholder="e.g. Brooklyn, NY ¬∑ Chicago, IL ¬∑ 90210‚Ä¶"
              value={location}
              onChange={e => { setLocation(e.target.value); setCoords(null); }}
              onKeyDown={e => e.key === "Enter" && handleSubmit()}
            />
            <button className="geo-btn" onClick={handleGeolocate} disabled={geoLoading} title="Use my current location">
              {geoLoading ? "‚è≥" : "üéØ"} {geoLoading ? "Locating‚Ä¶" : "Use My Location"}
            </button>
          </div>
        </div>

        <div className="field-row">
          <div className="field-group">
            <label className="field-label">üç¥ What are you craving?</label>
            <input
              placeholder="e.g. sushi, tacos, pizza, ramen‚Ä¶"
              value={cuisine}
              onChange={e => setCuisine(e.target.value)}
            />
          </div>
          <div className="field-group">
            <label className="field-label">ü•¶ Dietary needs <span className="field-optional">(optional)</span></label>
            <input
              placeholder="e.g. vegetarian, gluten-free, halal‚Ä¶"
              value={dietary}
              onChange={e => setDietary(e.target.value)}
            />
          </div>
        </div>

        <div className="field-group">
          <label className="field-label">üí∞ Budget</label>
          <div className="toggle-row">
            {BUDGETS.map(b => (
              <button key={b.v} className={"toggle-btn" + (budget === b.v ? " active" : "")} onClick={() => setBudget(b.v)}>
                {b.l}
              </button>
            ))}
          </div>
        </div>

        <div className="field-group">
          <label className="field-label">üéâ What's the occasion?</label>
          <div className="toggle-row">
            {OCCASIONS.map(o => (
              <button key={o.v} className={"toggle-btn" + (occasion === o.v ? " active" : "")} onClick={() => setOccasion(o.v)}>
                {o.l}
              </button>
            ))}
          </div>
        </div>

        <div className="field-group">
          <label className="field-label">üî¢ How many results?</label>
          <div className="toggle-row">
            {[3, 5, 10].map(n => (
              <button key={n} className={"toggle-btn" + (limit === n ? " active" : "")} onClick={() => setLimit(n)}>
                {n} restaurants
              </button>
            ))}
          </div>
        </div>
      </div>

      {error && <div className="error-box">‚ö†Ô∏è {error}</div>}

      <button className="submit-btn" onClick={handleSubmit} disabled={loading}>
        {loading ? `ü§ñ Llama is sniffing out the best spots${dots}` : "üöÄ Find My Perfect Restaurant"}
      </button>

      {loading && (
        <div className="loading-hint">Searching the web + asking Llama 3 70B on Groq for its top picks‚Ä¶</div>
      )}
    </div>
  );
}

/* ‚îÄ‚îÄ App ‚îÄ‚îÄ */
function App() {
  const [results,       setResults]       = useState(null);
  const [loading,       setLoading]       = useState(false);
  const [error,         setError]         = useState(null);
  const [health,        setHealth]        = useState(null);
  const [reviewTarget,  setReviewTarget]  = useState(null);

  useEffect(() => {
    apiFetch("/api/health").then(setHealth).catch(() => setHealth({ status: "unreachable" }));
  }, []);

  const handleSearch = async form => {
    setLoading(true); setError(null); setResults(null);
    try { setResults(await apiFetch("/api/recommend", { method: "POST", body: JSON.stringify(form) })); }
    catch (e) { setError(e.message); }
    finally { setLoading(false); }
  };

  const dotColor = !health ? "#64748b"
    : health.status === "unreachable" ? "#ef4444"
    : health.groq_configured && health.serper_configured ? "#4ade80" : "#f97316";

  const dotLabel = !health ? "Connecting‚Ä¶"
    : health.status === "unreachable" ? "Backend offline"
    : health.groq_configured && health.serper_configured ? "API Connected" : "Missing API keys";

  return (
    <div className="app">
      <div className="blob blob-1" />
      <div className="blob blob-2" />
      <div className="blob blob-3" />

      {/* Header */}
      <header className="header">
        <div className="header-inner">
          <div className="logo-row">
            <span className="logo-emoji">üçΩÔ∏è</span>
            <div>
              <div className="logo-name">TasteFind</div>
              <div className="logo-sub">AI-powered restaurant discovery</div>
            </div>
          </div>

          <div style={{display:"flex", alignItems:"center", gap:"10px", flexWrap:"wrap"}}>
            <div className="status-pill">
              <span className="status-dot" style={{background: dotColor}} />
              {dotLabel}
            </div>
            <div className="model-badge">
              <span className="badge-dot" />
              <span>‚ö°</span>
              <div className="badge-info">
                <span className="badge-label">Powered by</span>
                <span className="badge-model">Llama 3 70B</span>
              </div>
              <span className="badge-sep">¬∑</span>
              <span className="badge-groq">Groq</span>
            </div>
          </div>
        </div>
      </header>

      {/* Main */}
      <main className="wrap">
        <section className="hero">
          <h1 className="hero-title">Find your next<br /><em>perfect meal.</em></h1>
          <p className="hero-sub">Tell us what you're craving. Llama 3 reasons through live web search results to surface the spots that actually fit your vibe.</p>
        </section>

        <SearchForm onSearch={handleSearch} loading={loading} />

        {loading && <Loader />}

        {error && <div className="error-box">‚ö†Ô∏è {error}</div>}

        {results && (
          <section>
            {results.top_pick && (
              <div className="top-pick-banner">
                <div className="top-pick-tag">üèÜ Llama's Top Pick</div>
                <div className="top-pick-name">{results.top_pick}</div>
              </div>
            )}

            <AIPanel
              text={results.ai_recommendation}
              topPick={results.top_pick}
              count={results.restaurants.length}
            />

            <div className="cards-header">
              <h2 className="section-title">Matched Restaurants</h2>
              <span className="count-chip">{results.restaurants.length} found</span>
            </div>

            <div className="cards-grid">
              {results.restaurants.map((r, i) => (
                <RestaurantCard
                  key={r.id}
                  restaurant={r}
                  isTop={r.name === results.top_pick}
                  index={i}
                  onReviews={() => setReviewTarget(r)}
                />
              ))}
            </div>
          </section>
        )}
      </main>

      {/* Footer */}
      <footer className="footer">
        <span>Built with</span>
        <span className="footer-badge">ü¶ô Llama 3 70B</span>
        <span>+</span>
        <span className="footer-badge">‚ö° Groq</span>
        <span>+</span>
        <span className="footer-badge">üîç Serper</span>
      </footer>

      {reviewTarget && (
        <ReviewsModal restaurant={reviewTarget} onClose={() => setReviewTarget(null)} />
      )}
    </div>
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(<App />);
</script>
</body>
</html>